<?php// This file is part of Moodle - http://moodle.org///// Moodle is free software: you can redistribute it and/or modify// it under the terms of the GNU General Public License as published by// the Free Software Foundation, either version 3 of the License, or// (at your option) any later version.//// Moodle is distributed in the hope that it will be useful,// but WITHOUT ANY WARRANTY; without even the implied warranty of// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the// GNU General Public License for more details.//// You should have received a copy of the GNU General Public License// along with Moodle.  If not, see <http://www.gnu.org/licenses/>./** * ##Description## [TODO] * * * @package    block_like * @copyright  [TODO] * @author     [TODO] * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later */defined('MOODLE_INTERNAL') || die();/* [TODO] Fix bug */require_once(__DIR__.'/../../config.php');/** * Displays the current user's profile information. * * @copyright  [TODO] * @author     [TODO] * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later */class block_like extends block_base {    /**     * block initializations     * @throws coding_exception     */    public function init() {        $this->title = get_string('pluginname', 'block_like');    }    public function get_content() {        global $USER, $COURSE, $CFG, $DB;        /* 1) Récupération données */        /* [OLD]         * try {         *   $this->page->requires->js(new moodle_url($CFG->wwwroot . '/blocks/like/script/script.js'));         * } catch (moodle_exception $e) {         *    echo 'Exception moodle_exception (get_content -> block_like.php) : ',  $e->getMessage(), "\n";         * }        */        try {            $this->page->requires->css(new moodle_url($CFG->wwwroot . '/blocks/like/style/style.css'));        } catch (coding_exception $e) {            echo 'Exception coding_exception (get_content -> block_like.php) : ',  $e->getMessage(), "\n";        } catch (moodle_exception $e) {            echo 'Exception moodle_exception (get_content -> block_like.php) : ',  $e->getMessage(), "\n";        }        /* 2) Génération template */        if ($this->content !== null) {            return $this->content;        }        $this->content         = new stdClass;        $this->content->text   = 'The content of our SimpleHTML block !!!';        $this->content->footer = 'Footer here...';        $sql = 'SELECT Base.cmid, Base.type, IFNULL(COUNT(Base.cmid), 0) AS total,            IFNULL(TableTypeOne.TotalTypeOne, 0) AS typeone,            IFNULL(TableTypeTwo.TotalTypeTwo, 0) AS typetwo,            IFNULL(TableTypeThree.TotalTypethree, 0) AS typethree,            IFNULL(TableUser.UserVote, 0) AS uservote          FROM {block_like} AS Base            NATURAL LEFT JOIN (SELECT cmid, COUNT(vote) AS TotalTypeOne FROM {block_like}              WHERE vote = 1 GROUP BY cmid) AS TableTypeOne            NATURAL LEFT JOIN (SELECT cmid, COUNT(vote) AS TotalTypeTwo FROM {block_like}              WHERE vote = 2 GROUP BY cmid) AS TableTypeTwo            NATURAL LEFT JOIN (SELECT cmid, COUNT(vote) AS TotalTypethree FROM {block_like}              WHERE vote = 3 GROUP BY cmid) AS TableTypeThree            NATURAL LEFT JOIN (SELECT cmid, vote AS UserVote FROM mdl_block_like WHERE userid = :userid) AS TableUser          GROUP BY cmid;';        $params = array('userid' => $USER->id);        try {            $result = $DB->get_records_sql($sql, $params);        } catch (dml_exception $e) {            echo 'Exception : ',  $e->getMessage(), "\n";        }        echo var_dump($result);        /*$empty = new stdClass();        $empty->cmid*/        $likes = (!empty($result)) ? array_values($result) : array();        /* [OLD]        * Source : "Passing variables from PHP to JavaScript"        * (https://www.safaribooksonline.com/library/view/moodle-javascript-cookbook/9781849511902/ch01s06.html)        *        * $this->page->requires->js_init_call('getSqlData', array($arraysql));        */        $params = array($likes[0], $USER->id);        $this->page->requires->js_call_amd('block_like/script', 'init', $params);        /* [OLD]        * foreach ($arraysql as $id => $value) {        *    $addjs = "require(['jquery'], function($) { var arraySQL = ". json_encode($value->cmid) ."; });";        *    $PAGE->requires->js_init_code($addjs);        *    $PAGE->requires->js_init_code(js_writer::set_variable('arraySQL', $value->cmid));        * }        */        return $this->content;    }    public function test($text) {        echo json_encode("Yes !" . $text);    }}