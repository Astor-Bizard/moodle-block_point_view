define(["jquery","core/ajax","core/notification"],function(a,b,c){function d(b){b(),a(document).ajaxComplete(function(a,c,d){if(void 0!==d.data){var e=JSON.parse(d.data);e.length>0&&void 0!==e[0].methodname&&"format_tiles_get_single_section_page_html"===e[0].methodname&&b()}})}return{init:function(e){a(function(){var f=a(".block.block_point_view .block_point_view_data").data("blockdata");d(function(){var b,c;b=f.difficultylevels,c=f.trackcolors,b.forEach(function(b){var d=a('<div class="block_point_view track"></div>').css({"background-color":c[parseInt(b.difficultyLevel)]}),e=a("#module-"+b.id+" .mod-indent-outer");0===e.find(".block_point_view.track").length&&e.prepend(d),e.find(".mod-indent").after(d)})});var g={none:0,easy:1,better:2,hard:3},h={};function i(b,c){var d=a("#module-"+b+" .block_point_view.reactions-container");return void 0===c?d:d.find(c)}function j(b){var c="group_";i(b,".reactionnb").each(function(){parseInt(a(this).text())>0&&(c+=a(this).data("reactionname").toUpperCase().charAt(0))}),i(b,".group_img").attr("src",f.pix[c])}function k(a,b){var c=i(a,".group_nb"),d=c.find("span"),e=Math.min((""+b).length,5);d.text(b).attr("title",M.util.get_string("totalreactions","block_point_view",b)).css({right:Math.max(.25*(e-2),0)+"em",transform:"scaleX("+(1+.03*e*e-.35*e+.34)+")"}),c.toggleClass("novote",0===b).toggleClass("voted",h[a]!==g.none)}function l(a){return{top:15-10*a,left:10-10*a,height:20*a}}function m(a){return{left:10*a-10,height:20*a}}function n(a,b,c,d){var e=i(a,'.reactionnb[data-reactionname="'+b+'"]'),f=parseInt(e.text())+c;e.text(f).toggleClass("nbselected",d),i(a,'.reaction img[data-reactionname="'+b+'"]').toggleClass("novote",0===f),k(a,parseInt(i(a,".group_nb").find("span").text())+c)}a(".activity").mouseover(function(){a(this).css({background:"linear-gradient(to right, rgba(0,0,0,0.04), rgba(0,0,0,0.04), transparent)","border-radius":"5px"})}).mouseout(function(){a(this).css({background:""})}),d(function(){var d=f.reactionstemplate;f.moduleswithreactions.forEach(function(f){var o=parseInt(f.cmid),p=parseInt(f.uservote);if(h[o]=p,1===a("#module-"+o).length&&0===i(o).length){var q=a(d);a("#module-"+o).prepend(q),q.find(".reaction img").each(function(){a(this).toggleClass("novote",0===parseInt(f["total"+a(this).data("reactionname")]))}),q.find(".reactionnb").each(function(){a(this).text(f["total"+a(this).data("reactionname")]).toggleClass("nbselected",p===g[a(this).data("reactionname")])}),k(o,parseInt(f.totaleasy)+parseInt(f.totalbetter)+parseInt(f.totalhard)),function(d){j(d);var f=!1,k=null,o=null,p=function(){o=null,f=!1,function(b){["hard","better","easy"].forEach(function(c,d){var e=50+250*d;i(b,'.reaction img[data-reactionname="'+c+'"]').css({"pointer-events":"none"}).delay(e).animate(l(0),500),i(b,'.reactionnb[data-reactionname="'+c+'"]').delay(e).queue(function(b){a(this).removeClass("shown"),b()})}),j(b),i(b,".group_img").delay(500).show(0).animate(m(1),300).css({"pointer-events":"auto"}),i(b,".group_nb").delay(600).show(0),a("#module-"+b+" .actions").delay(600).show(300)}(d)},q=function(){k=null,f=!0,function(b){i(b,".group_img").css({"pointer-events":"none"}).animate(m(0),300).hide(0),i(b,".group_nb").delay(50).hide(300),a("#module-"+b+" .actions").delay(200).hide(300),["easy","better","hard"].forEach(function(c,d){var e=50+150*d;i(b,'.reaction img[data-reactionname="'+c+'"]').delay(e).animate(l(1),300).css({"pointer-events":"auto"}),i(b,'.reactionnb[data-reactionname="'+c+'"]').delay(e+300).queue(function(b){a(this).addClass("shown"),b()})})}(d),clearTimeout(o),o=setTimeout(p,2e3)};i(d,".group_img").mouseover(function(){a(this).stop().animate(m(1.15),100),k=setTimeout(q,300)}).mouseout(function(){f||(clearTimeout(k),a(this).stop().animate(m(1),100))}).click(q);var r=!1;i(d,".reaction img").mouseover(function(){a(this).stop().animate(l(2),100)}).mouseout(function(){a(this).stop().animate(l(1),100)}).click(function(){!1===r&&(r=!0,function(a,d){var f=g[d],i=h[a],j=f===i?g.none:f;return b.call([{methodname:"block_point_view_update_db",args:{func:"update",courseid:e,cmid:a,vote:j}}])[0].done(function(){if(h[a]=j,i!==g.none){var b=["","easy","better","hard"][i];n(a,b,-1,!1)}j!==g.none&&n(a,d,1,!0)}).fail(c.exception)}(d,a(this).data("reactionname")).done(function(){r=!1}))}),i(d,".reactions").mouseout(function(){clearTimeout(o),o=setTimeout(p,1e3)}).mouseover(function(){clearTimeout(o)})}(o)}})})})}}});